<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gemini Live ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—èµ·ã“ã—</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; margin: 24px; }
    .container { max-width: 920px; margin: 0 auto; }
    h1 { font-size: 22px; margin-bottom: 8px; }
    .status-message { padding: 10px 12px; border-radius: 8px; background: #f4f6f8; margin: 12px 0; }
    .status-message.success { background: #eef9f0; }
    .status-message.error { background: #ffecec; color: #c62828; }
    textarea { width: 100%; box-sizing: border-box; padding: 10px; height: 260px; }
    .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .btn { padding: 8px 14px; border: 1px solid #ddd; border-radius: 8px; background: white; cursor: pointer; }
    .btn[disabled] { opacity: .5; cursor: not-allowed; }
    .btn.primary { background: #1967d2; color: white; border-color: #1967d2; }
    .btn.danger { background: #c62828; color: white; border-color: #c62828; }
    .hint { color: #666; font-size: 13px; }
    .llm-area { margin-top: 24px; }
    pre { white-space: pre-wrap; word-break: break-word; background: #fafafa; padding: 12px; border-radius: 8px; border: 1px solid #eee; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gemini Live ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—èµ·ã“ã—ï¼ˆã‚³ãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼å¯¾å¿œï¼‰</h1>

    <div id="status" class="status-message">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æº–å‚™å®Œäº†ã€‚ã€Œæ–‡å­—èµ·ã“ã—é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</div>

    <div class="controls" style="margin-bottom: 12px;">
      <button id="start" class="btn primary">ğŸ¤ æ–‡å­—èµ·ã“ã—é–‹å§‹</button>
      <button id="stop" class="btn danger" disabled>â¹ åœæ­¢</button>
      <label style="margin-left: 16px;">
        <input type="checkbox" id="useSystemAudio" checked>
        ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°ï¼ˆã‚³ãƒ©ãƒœã‚¹ï¼‰ã‚‚å«ã‚ã‚‹
      </label>
      <span class="hint">â€» ãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ±‚ã‚ã¾ã™</span>
    </div>

    <div id="audioDebug" style="margin: 12px 0; padding: 10px; background: #f0f0f0; border-radius: 8px; display: none;">
      <div><strong>éŸ³å£°å…¥åŠ›æƒ…å ±:</strong></div>
      <div id="micInfo">ãƒã‚¤ã‚¯: æœªæ¥ç¶š</div>
      <div id="sysInfo">ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°: æœªæ¥ç¶š</div>
      <div id="audioLevel" style="margin-top: 8px;">
        <div style="font-size: 13px; color: #666; margin-bottom: 4px;">ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆãƒã‚¤ã‚¯ï¼‰éŸ³é‡:</div>
        <div style="height: 20px; background: #ddd; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
          <div id="micLevelBar" style="height: 100%; width: 0%; background: #1967d2; transition: width 0.1s;"></div>
        </div>
        <div style="font-size: 13px; color: #666; margin-bottom: 4px;">é¡§å®¢ï¼ˆã‚³ãƒ©ãƒœã‚¹ï¼‰éŸ³é‡:</div>
        <div style="height: 20px; background: #ddd; border-radius: 4px; overflow: hidden;">
          <div id="sysLevelBar" style="height: 100%; width: 0%; background: #e91e63; transition: width 0.1s;"></div>
        </div>
        <div id="currentSpeaker" style="margin-top: 8px; font-weight: bold; color: #1967d2;">ç¾åœ¨ã®è©±è€…: --</div>
      </div>
    </div>

    <textarea id="transcript" placeholder="ã“ã“ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ–‡å­—èµ·ã“ã—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™..."></textarea>

    <div class="llm-area">
      <div class="controls">
        <button id="summarize" class="btn" disabled>âœ¨ è¦ç´„ã‚’ç”Ÿæˆ</button>
        <button id="terms" class="btn" disabled>âœ¨ å°‚é–€ç”¨èªã‚’ãƒã‚§ãƒƒã‚¯</button>
        <button id="saveSession" class="btn" disabled>ğŸ’¾ ä¿å­˜</button>
        <button id="viewHistory" class="btn">ğŸ“‹ å±¥æ­´ã‚’è¡¨ç¤º</button>
        <span class="hint">ï¼ˆåœæ­¢å¾Œã«å®Ÿè¡Œã§ãã¾ã™ï¼‰</span>
      </div>
      <div id="llmOut" style="margin-top: 10px;"></div>
    </div>

    <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="historyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
      <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 24px; border-radius: 12px; max-width: 800px; max-height: 80%; overflow-y: auto; width: 90%;">
        <h2 style="margin-top: 0;">æ–‡å­—èµ·ã“ã—å±¥æ­´</h2>
        <div id="historyList"></div>
        <div style="margin-top: 16px; text-align: right;">
          <button id="closeHistory" class="btn">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ===== è¨­å®š =====
    const GEMINI_LIVE_ENDPOINT = 'wss://generativelanguage.googleapis.com/ws/google.ai.generativelanguage.v1alpha.GenerativeService.BidiGenerateContent';
    const API_KEY_ENDPOINT = '/api-key';                // APIã‚­ãƒ¼ã‚µãƒ¼ãƒ
    const TEXT_GEN_ENDPOINT = '/text-generate';         // ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆãƒ—ãƒ­ã‚­ã‚·
    const SAMPLE_RATE = 16000;
    const CHUNK_SIZE = 2048; // ScriptProcessor ã®ãƒãƒƒãƒ•ã‚¡

    // ===== DOM =====
    const $status = document.getElementById('status');
    const $start = document.getElementById('start');
    const $stop = document.getElementById('stop');
    const $txt = document.getElementById('transcript');
    const $sum = document.getElementById('summarize');
    const $terms = document.getElementById('terms');
    const $out = document.getElementById('llmOut');
    const $useSystemAudio = document.getElementById('useSystemAudio');
    const $audioDebug = document.getElementById('audioDebug');
    const $micInfo = document.getElementById('micInfo');
    const $sysInfo = document.getElementById('sysInfo');
    const $micLevelBar = document.getElementById('micLevelBar');
    const $sysLevelBar = document.getElementById('sysLevelBar');
    const $currentSpeaker = document.getElementById('currentSpeaker');
    const $saveSession = document.getElementById('saveSession');
    const $viewHistory = document.getElementById('viewHistory');
    const $historyModal = document.getElementById('historyModal');
    const $historyList = document.getElementById('historyList');
    const $closeHistory = document.getElementById('closeHistory');

    // ===== çŠ¶æ…‹ =====
    let ws = null;            // WebSocket æ¥ç¶š
    let audioContext = null;  // WebAudio
    let micStream = null;     // ãƒã‚¤ã‚¯
    let sysStream = null;     // ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°ï¼ˆç”»é¢å…±æœ‰ï¼‰
    let recorder = null;      // ScriptProcessorNode
    let currentSessionId = null; // ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ID
    let autoSaveInterval = null; // è‡ªå‹•ä¿å­˜ã‚¿ã‚¤ãƒãƒ¼

    // è©±è€…åˆ¤å®š
    let currentSpeaker = null; // 'operator' | 'customer' | null
    let micAnalyser = null;
    let sysAnalyser = null;
    let micDataArray = null;
    let sysDataArray = null;
    let levelMonitorInterval = null; // éŸ³é‡ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ç”¨ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«

    // éŸ³é‡ãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—ï¼ˆRMSå€¤ï¼‰
    function calculateAudioLevel(analyser, dataArray) {
      if (!analyser || !dataArray) return 0;
      analyser.getByteTimeDomainData(dataArray);

      let sum = 0;
      for (let i = 0; i < dataArray.length; i++) {
        const normalized = (dataArray[i] - 128) / 128; // -1 to 1
        sum += normalized * normalized;
      }
      const rms = Math.sqrt(sum / dataArray.length);
      return rms;
    }

    // éŸ³é‡ãƒ¬ãƒ™ãƒ«ã‚’ç›£è¦–ã—ã¦è©±è€…ã‚’åˆ¤å®š
    function monitorAudioLevels() {
      const micLevel = calculateAudioLevel(micAnalyser, micDataArray);
      const sysLevel = calculateAudioLevel(sysAnalyser, sysDataArray);

      // UIã®éŸ³é‡ãƒãƒ¼ã‚’æ›´æ–°ï¼ˆ0-100%ï¼‰
      const micPercent = Math.min(100, micLevel * 200); // å€ç‡èª¿æ•´
      const sysPercent = sysAnalyser && sysDataArray ? Math.min(100, sysLevel * 200) : 0;

      $micLevelBar.style.width = micPercent + '%';
      if (sysAnalyser) {
        $sysLevelBar.style.width = sysPercent + '%';
      }

      // è©±è€…åˆ¤å®šï¼ˆéŸ³é‡ã®å¤§ãã„æ–¹ã€é–¾å€¤0.05ä»¥ä¸Šï¼‰
      const threshold = 0.05;
      let newSpeaker = null;

      if (micLevel > threshold || sysLevel > threshold) {
        if (micLevel > sysLevel) {
          newSpeaker = 'operator';
        } else {
          newSpeaker = 'customer';
        }
      }

      // è©±è€…ãŒå¤‰ã‚ã£ãŸå ´åˆã®ã¿æ›´æ–°
      if (newSpeaker !== currentSpeaker) {
        currentSpeaker = newSpeaker;
        if (currentSpeaker === 'operator') {
          $currentSpeaker.textContent = 'ç¾åœ¨ã®è©±è€…: ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆãƒã‚¤ã‚¯ï¼‰';
          $currentSpeaker.style.color = '#1967d2';
        } else if (currentSpeaker === 'customer') {
          $currentSpeaker.textContent = 'ç¾åœ¨ã®è©±è€…: é¡§å®¢ï¼ˆã‚³ãƒ©ãƒœã‚¹ï¼‰';
          $currentSpeaker.style.color = '#e91e63';
        } else {
          $currentSpeaker.textContent = 'ç¾åœ¨ã®è©±è€…: --';
          $currentSpeaker.style.color = '#666';
        }
      }
    }

    // éŸ³é‡ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚’é–‹å§‹
    function startLevelMonitoring() {
      if (levelMonitorInterval) return;
      levelMonitorInterval = setInterval(monitorAudioLevels, 100); // 100msã”ã¨ã«æ›´æ–°
      console.log('Audio level monitoring started');
    }

    // éŸ³é‡ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚’åœæ­¢
    function stopLevelMonitoring() {
      if (levelMonitorInterval) {
        clearInterval(levelMonitorInterval);
        levelMonitorInterval = null;
        currentSpeaker = null;
        $currentSpeaker.textContent = 'ç¾åœ¨ã®è©±è€…: --';
        $currentSpeaker.style.color = '#666';
        $micLevelBar.style.width = '0%';
        $sysLevelBar.style.width = '0%';
        console.log('Audio level monitoring stopped');
      }
    }

    // ===== ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† =====
    function createSession() {
      currentSessionId = Date.now().toString();
      const session = {
        id: currentSessionId,
        startTime: new Date().toISOString(),
        transcript: '',
        endTime: null
      };
      console.log('Created new session:', currentSessionId);
      return session;
    }

    function saveCurrentSession() {
      if (!currentSessionId) return;

      const sessions = JSON.parse(localStorage.getItem('transcriptSessions') || '[]');
      const existingIndex = sessions.findIndex(s => s.id === currentSessionId);

      const session = {
        id: currentSessionId,
        startTime: existingIndex >= 0 ? sessions[existingIndex].startTime : new Date().toISOString(),
        transcript: $txt.value,
        endTime: new Date().toISOString(),
        length: $txt.value.length
      };

      if (existingIndex >= 0) {
        sessions[existingIndex] = session;
      } else {
        sessions.unshift(session);
      }

      // æœ€æ–°50ä»¶ã®ã¿ä¿å­˜
      const trimmedSessions = sessions.slice(0, 50);
      localStorage.setItem('transcriptSessions', JSON.stringify(trimmedSessions));
      console.log('Session saved:', currentSessionId);
      setStatus('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
    }

    function startAutoSave() {
      // 10ç§’ã”ã¨ã«è‡ªå‹•ä¿å­˜
      autoSaveInterval = setInterval(() => {
        if ($txt.value.trim().length > 0) {
          saveCurrentSession();
          console.log('Auto-saved at', new Date().toLocaleTimeString());
        }
      }, 10000);
    }

    function stopAutoSave() {
      if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
        autoSaveInterval = null;
      }
    }

    function setStatus(msg, type='') {
      $status.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${msg}`;
      $status.className = `status-message ${type}`.trim();
    }
    function updateButtons(running) {
      $start.disabled = running;
      $stop.disabled = !running;
      const hasText = ($txt.value.trim().length > 0);
      $sum.disabled = running || !hasText;
      $terms.disabled = running || !hasText;
      $saveSession.disabled = running || !hasText;
    }

    async function fetchApiKey() {
      const res = await fetch(API_KEY_ENDPOINT, { method: 'POST' });
      if (!res.ok) throw new Error(`APIã‚­ãƒ¼å–å¾—ã«å¤±æ•—: ${res.status}`);
      const { apiKey } = await res.json();
      if (!apiKey) throw new Error('APIã‚­ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒä¸æ­£');
      return apiKey;
    }

async function startTranscription() {
  setStatus('éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ å–å¾—ä¸­...');
  updateButtons(true);
  $out.innerHTML = '';
  $txt.value = '';

  // æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
  createSession();
  startAutoSave();
  console.log('Auto-save enabled: åˆ¥ã‚¿ãƒ–ã§ä½œæ¥­ä¸­ã§ã‚‚10ç§’ã”ã¨ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™');

  try {
    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
    $audioDebug.style.display = 'block';

    // 1) ãƒã‚¤ã‚¯å–å¾—
    const micOnly = !$useSystemAudio.checked; // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§åˆ¶å¾¡
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });

    // ãƒã‚¤ã‚¯æƒ…å ±ã‚’è¡¨ç¤º
    const micTrack = micStream.getAudioTracks()[0];
    $micInfo.textContent = `ãƒã‚¤ã‚¯: ${micTrack.label || 'æ¥ç¶šæ¸ˆã¿'} (ãƒ‡ãƒã‚¤ã‚¹ID: ${micTrack.id.substring(0, 8)}...)`;
    console.log('Microphone track:', micTrack);

    if (micOnly) {
      setStatus('ãƒã‚¤ã‚¯ã®ã¿ã§æ¥ç¶šæº–å‚™ä¸­...');
      $sysInfo.textContent = 'ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°: ä½¿ç”¨ã—ãªã„';
    } else {
      setStatus('ãƒã‚¤ã‚¯å–å¾—å®Œäº†ã€‚æ¬¡ã«ç”»é¢å…±æœ‰ï¼ˆã‚·ã‚¹ãƒ†ãƒ éŸ³å£°ï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„...');
    }

    // 2) WebAudio æº–å‚™ï¼ˆ16kHzï¼‰
    audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: SAMPLE_RATE });
    const micSrc = audioContext.createMediaStreamSource(micStream);

    // ãƒã‚¤ã‚¯ç”¨ã®AnalyserNodeã‚’ä½œæˆ
    micAnalyser = audioContext.createAnalyser();
    micAnalyser.fftSize = 256;
    micDataArray = new Uint8Array(micAnalyser.frequencyBinCount);
    micSrc.connect(micAnalyser);

    let merger = null;
    if (!micOnly) {
      // ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°ï¼ˆã‚³ãƒ©ãƒœã‚¹ãªã©ï¼‰ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
      try {
        // Chromeã®ç”»é¢å…±æœ‰ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã€Œã‚·ã‚¹ãƒ†ãƒ ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚’å…±æœ‰ã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„
        sysStream = await navigator.mediaDevices.getDisplayMedia({
          video: true, // ç”»é¢é¸æŠã®ãŸã‚å¿…è¦ï¼ˆæ˜ åƒã¯ä½¿ã‚ãªã„ï¼‰
          audio: {
            echoCancellation: false,
            noiseSuppression: false,
            autoGainControl: false,
            suppressLocalAudioPlayback: false
          }
        });
        // æ˜ åƒãƒˆãƒ©ãƒƒã‚¯ã¯ä¸è¦ãªã®ã§åœæ­¢
        sysStream.getVideoTracks().forEach(t => t.stop());
        console.log('System audio tracks:', sysStream.getAudioTracks().length);
      } catch (e) {
        console.warn('ç”»é¢å…±æœ‰ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚ãƒã‚¤ã‚¯ã®ã¿ã§ç¶šè¡Œã—ã¾ã™ã€‚', e);
        setStatus('ç”»é¢å…±æœ‰ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚ãƒã‚¤ã‚¯ã®ã¿ã§ç¶šè¡Œã—ã¾ã™ã€‚');
        sysStream = null;
      }
    }

    // å…¥åŠ›ãƒãƒ£ãƒ³ãƒãƒ«ã‚’å®‰å…¨ã« 1ch ã«ã¾ã¨ã‚ã‚‹
    const inChannels = (micOnly || !sysStream) ? 1 : 2;
    merger = audioContext.createChannelMerger(inChannels);
    micSrc.connect(merger, 0, 0);

    if (!micOnly && sysStream) {
      const sysTracks = sysStream.getAudioTracks();
      const videoTracks = sysStream.getVideoTracks();

      // å…±æœ‰ã—ã¦ã„ã‚‹ã‚½ãƒ¼ã‚¹ã®æƒ…å ±ã‚’è¡¨ç¤º
      if (videoTracks.length > 0) {
        console.log('Shared source:', videoTracks[0].label);
      }

      if (sysTracks.length > 0) {
        const sysTrack = sysTracks[0];
        $sysInfo.textContent = `ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°: ${sysTrack.label || 'æ¥ç¶šæ¸ˆã¿'} (ã‚½ãƒ¼ã‚¹: ${videoTracks[0]?.label || 'ä¸æ˜'})`;
        console.log('System audio track:', sysTrack);
        console.log('Video track (shared source):', videoTracks[0]);

        const sysSrc = audioContext.createMediaStreamSource(sysStream);

        // ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°ç”¨ã®AnalyserNodeã‚’ä½œæˆ
        sysAnalyser = audioContext.createAnalyser();
        sysAnalyser.fftSize = 256;
        sysDataArray = new Uint8Array(sysAnalyser.frequencyBinCount);
        sysSrc.connect(sysAnalyser);

        sysSrc.connect(merger, 0, 1);
        setStatus('ãƒã‚¤ã‚¯ + ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°ï¼ˆã‚³ãƒ©ãƒœã‚¹éŸ³å£°ï¼‰ã‚’é€ä¿¡ã—ã¾ã™ã€‚æ¥ç¶šæº–å‚™ä¸­...');
        console.log('System audio enabled: ãƒã‚¤ã‚¯ã¨ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°ã®ä¸¡æ–¹ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¾ã™');
      } else {
        setStatus('ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°ãƒˆãƒ©ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãšã€ãƒã‚¤ã‚¯ã®ã¿ã§ç¶šè¡Œã—ã¾ã™ã€‚');
        $sysInfo.textContent = 'ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°: å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆã€Œã‚·ã‚¹ãƒ†ãƒ ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚’å…±æœ‰ã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼‰';
        console.warn('ç”»é¢å…±æœ‰æ™‚ã«ã€Œã‚·ã‚¹ãƒ†ãƒ ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚’å…±æœ‰ã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„');
      }
    }

    // ScriptProcessor ã¯ç’°å¢ƒå·®ã§ NotSupported ã«ãªã‚Šã†ã‚‹ã®ã§ try ã§ä¿è­·
    try {
      recorder = audioContext.createScriptProcessor(CHUNK_SIZE, inChannels, 1);
    } catch (e) {
      recorder = audioContext.createScriptProcessor(2048, inChannels, 1);
    }
    merger.connect(recorder);
    recorder.connect(audioContext.destination);

    // 3) APIã‚­ãƒ¼ã§ Live API æ¥ç¶š
    const apiKey = await fetchApiKey();
    const url = `${GEMINI_LIVE_ENDPOINT}?key=${encodeURIComponent(apiKey)}`;
    ws = new WebSocket(url);
    ws.binaryType = "arraybuffer";

    ws.onopen = async () => {
      setStatus('Gemini Live ã«æ¥ç¶šã—ã¾ã—ãŸã€‚ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...', 'success');
      try { await audioContext.resume(); } catch {}

      // æ­£ã—ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
      const init = {
        setup: {
          model: 'models/gemini-2.0-flash-live-001',
          generationConfig: {
            responseModalities: ['TEXT'],
          },
          systemInstruction: {
            parts: [{
              text: 'ã‚ãªãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éŸ³å£°å…¥åŠ›ã‚’å³å¯†ã«æ–‡å­—èµ·ã“ã—ã™ã‚‹ã‚¨ãƒ³ã‚¸ãƒ³ã§ã™ã€‚å¥èª­ç‚¹å«ã‚æ­£ç¢ºãªæ—¥æœ¬èªã§æ›¸ãèµ·ã“ã—ã¦ãã ã•ã„ã€‚å¿œç­”ã‚„è¦ç´„ã¯ã—ãªã„ã§ãã ã•ã„ã€‚'
            }]
          }
        }
      };
      console.log('Sending setup:', JSON.stringify(init, null, 2));
      ws.send(JSON.stringify(init));
    };

    let setupComplete = false;

    ws.onmessage = (ev) => {
      // ArrayBufferã‚’ãƒ†ã‚­ã‚¹ãƒˆã«ãƒ‡ã‚³ãƒ¼ãƒ‰
      let messageText;
      if (ev.data instanceof ArrayBuffer) {
        const decoder = new TextDecoder('utf-8');
        messageText = decoder.decode(ev.data);
      } else {
        messageText = ev.data;
      }

      // JSONãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡¦ç†
      try {
        const data = JSON.parse(messageText);
        console.log('Received message:', JSON.stringify(data, null, 2));

        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒã‚§ãƒƒã‚¯
        if (data.error) {
          console.error('Server error:', data.error);
          setStatus(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${JSON.stringify(data.error)}`, 'error');
        }

        // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾…ã¤
        if (data.setupComplete) {
          console.log('Setup complete, starting audio transmission...');
          setupComplete = true;
          setStatus('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ã€‚æ–‡å­—èµ·ã“ã—ã‚’é–‹å§‹ã—ã¾ã™ã€‚', 'success');

          // éŸ³é‡ãƒ¬ãƒ™ãƒ«ç›£è¦–ã‚’é–‹å§‹
          startLevelMonitoring();

          // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†å¾Œã€éŸ³å£°é€ä¿¡ã‚’é–‹å§‹
          let audioChunkCount = 0;
          recorder.onaudioprocess = (e) => {
            if (!ws || ws.readyState !== WebSocket.OPEN || !setupComplete) return;

            const nCh = e.inputBuffer.numberOfChannels;
            const ch0 = nCh > 0 ? e.inputBuffer.getChannelData(0) : new Float32Array(0);
            const ch1 = nCh > 1 ? e.inputBuffer.getChannelData(1) : null;

            const len = ch0.length;
            const pcm16 = new Int16Array(len);
            for (let i = 0; i < len; i++) {
              const r = ch1 ? ch1[i] : 0;
              const mixed = ((ch0[i] || 0) + (r || 0)) / (ch1 ? 2 : 1);
              const s = Math.max(-1, Math.min(1, mixed));
              pcm16[i] = (s * 0x7fff) | 0;
            }

            // realtimeInputãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦éŸ³å£°ã‚’é€ä¿¡ï¼ˆæ­£ã—ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰
            const uint8Array = new Uint8Array(pcm16.buffer);
            let binary = '';
            for (let i = 0; i < uint8Array.byteLength; i++) {
              binary += String.fromCharCode(uint8Array[i]);
            }
            const base64Audio = btoa(binary);

            const audioMsg = {
              realtimeInput: {
                audio: {
                  mimeType: 'audio/pcm;rate=16000',
                  data: base64Audio
                }
              }
            };
            ws.send(JSON.stringify(audioMsg));

            // æœ€åˆã®æ•°ãƒãƒ£ãƒ³ã‚¯ã ã‘ãƒ­ã‚°å‡ºåŠ›
            if (audioChunkCount < 3) {
              console.log(`Sending audio chunk #${audioChunkCount}, size: ${pcm16.buffer.byteLength} bytes`);
              if (audioChunkCount === 0) {
                console.log('Sample audio message:', audioMsg);
              }
              audioChunkCount++;
            }
          };
        }

        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆæ–‡å­—èµ·ã“ã—çµæœï¼‰ã‚’å‡¦ç†
        if (data.serverContent) {
          console.log('serverContent received:', data.serverContent);

          // modelTurn.parts[0].text ã‹ã‚‰å–å¾—
          const text = data.serverContent.modelTurn?.parts?.[0]?.text;
          if (text) {
            console.log('Transcription text:', text);

            // è©±è€…ãƒ©ãƒ™ãƒ«ã‚’ä»˜åŠ 
            let speakerLabel = '';
            if (currentSpeaker === 'operator') {
              speakerLabel = '[ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼] ';
            } else if (currentSpeaker === 'customer') {
              speakerLabel = '[é¡§å®¢] ';
            }

            $txt.value += speakerLabel + text;
            $txt.scrollTop = $txt.scrollHeight;
          } else {
            console.log('serverContent has no text in modelTurn.parts[0]');
          }
        }

        // ãã®ä»–ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã‚‚ãƒ­ã‚°å‡ºåŠ›
        if (data.toolCall) {
          console.log('toolCall received:', data.toolCall);
        }
        if (data.toolCallCancellation) {
          console.log('toolCallCancellation received:', data.toolCallCancellation);
        }
      } catch (err) {
        console.warn('Message parse error:', err, 'Data:', ev.data);
      }
    };

    ws.onerror = (err) => {
      console.error('WebSocket error', err);
      setStatus('WebSocketã‚¨ãƒ©ãƒ¼ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
      stopTranscription();
    };

    ws.onclose = (ev) => {
      console.warn("WS closed:", {code: ev.code, reason: ev.reason});
      setStatus(`æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸï¼ˆcode=${ev.code} reason=${ev.reason || 'n/a'}ï¼‰ã€‚å†é–‹ã§ãã¾ã™ã€‚`);
      updateButtons(false);
    };
  } catch (e) {
    console.error('startTranscription error', e);
    const msg = (e?.name === 'NotAllowedError' || e?.name === 'NotFoundError')
      ? 'æ¨©é™ã‚¨ãƒ©ãƒ¼: ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦è¨±å¯ã—ã¦ãã ã•ã„ã€‚'
      : `åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${e?.message || e}`;
    setStatus(msg, 'error');
    updateButtons(false);
  }
}

    function stopTranscription() {
      setStatus('åœæ­¢å‡¦ç†ä¸­...');

      // è‡ªå‹•ä¿å­˜ã‚’åœæ­¢ã—ã¦æœ€çµ‚ä¿å­˜
      stopAutoSave();
      if ($txt.value.trim().length > 0) {
        saveCurrentSession();
      }

      // éŸ³é‡ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚’åœæ­¢
      stopLevelMonitoring();

      // WebSocket
      try { ws?.close(1000, 'user close'); } catch(_){}
      ws = null;
      // Audio
      try { recorder?.disconnect(); } catch(_){}
      recorder = null;
      try { audioContext?.close(); } catch(_){}
      audioContext = null;
      try { micStream?.getTracks().forEach(t => t.stop()); } catch(_){}
      micStream = null;
      try { sysStream?.getTracks().forEach(t => t.stop()); } catch(_){}
      sysStream = null;

      // AnalyserNodeã‚’ã‚¯ãƒªã‚¢
      micAnalyser = null;
      sysAnalyser = null;
      micDataArray = null;
      sysDataArray = null;

      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’éè¡¨ç¤º
      $audioDebug.style.display = 'none';
      $micInfo.textContent = 'ãƒã‚¤ã‚¯: æœªæ¥ç¶š';
      $sysInfo.textContent = 'ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°: æœªæ¥ç¶š';

      setStatus('åœæ­¢å®Œäº†ã€‚æ–‡å­—èµ·ã“ã—çµæœã‚’è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸã€‚åˆ†ææ©Ÿèƒ½ã‚’ä½¿ãˆã¾ã™ã€‚', 'success');
      updateButtons(false);
    }

    async function callTextGen(systemInstruction, userQuery, model = 'gemini-1.5-flash') {
      const payload = { systemInstruction, userQuery, model };
      console.log('Calling text generation API:', TEXT_GEN_ENDPOINT);
      console.log('Payload:', payload);

      try {
        const res = await fetch(TEXT_GEN_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        console.log('Response status:', res.status);

        if (!res.ok) {
          const errorText = await res.text();
          console.error('Error response:', errorText);
          throw new Error(`ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã«å¤±æ•—: ${res.status} - ${errorText.substring(0, 200)}`);
        }

        const data = await res.json();
        console.log('Response data:', data);
        return data.text || '';
      } catch (e) {
        console.error('Text generation error:', e);
        throw e;
      }
    }

    async function summarize() {
      const t = $txt.value.trim();
      if (!t) {
        alert('æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã™ã€‚');
        return;
      }
      $sum.disabled = $terms.disabled = true;
      $out.innerHTML = '<pre>âœ¨ è¦ç´„ã‚’ç”Ÿæˆä¸­...</pre>';
      try {
        const sys = 'ã‚ãªãŸã¯ãƒ—ãƒ­ã®ã‚µãƒãƒ©ã‚¤ã‚¶ãƒ¼ã§ã™ã€‚æä¾›ã•ã‚ŒãŸæ—¥æœ¬èªã®ä¼šè­°ã¾ãŸã¯ä¼šè©±ã®æ–‡å­—èµ·ã“ã—ã‚’èª­ã¿ã€ä¸»è¦ãªè«–ç‚¹ã€æ±ºå®šäº‹é …ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å«ã‚€ç°¡æ½”ãªç®‡æ¡æ›¸ãã®è¦ç´„ã‚’æ—¥æœ¬èªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚';
        const uq = `ä»¥ä¸‹ã®æ–‡å­—èµ·ã“ã—ã‚’è¦ç´„ã—ã¦ãã ã•ã„:\n\n---\n${t}`;
        console.log('Starting summarization...');
        const text = await callTextGen(sys, uq);
        $out.innerHTML = `<h3>è¦ç´„çµæœ</h3><pre>${text}</pre>`;
        setStatus('è¦ç´„ãŒå®Œäº†ã—ã¾ã—ãŸã€‚', 'success');
      } catch (e) {
        console.error('Summarization error:', e);
        const errorMsg = e?.message || String(e);
        $out.innerHTML = `<pre style="color:#c62828">è¦ç´„ã‚¨ãƒ©ãƒ¼: ${errorMsg}\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</pre>`;
        setStatus('è¦ç´„ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
      } finally {
        updateButtons(false);
      }
    }

    async function terms() {
      const t = $txt.value.trim();
      if (!t) {
        alert('æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã™ã€‚');
        return;
      }
      $sum.disabled = $terms.disabled = true;
      $out.innerHTML = '<pre>âœ¨ å°‚é–€ç”¨èªã‚’åˆ†æä¸­...</pre>';
      try {
        const sys = 'ã‚ãªãŸã¯å­¦è¡“çš„ãªã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚æä¾›ã•ã‚ŒãŸæ—¥æœ¬èªã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã€å°‚é–€çš„/æŠ€è¡“çš„ãªç”¨èªã‚’æœ€å¤§5ã¤æŠ½å‡ºã—ã€éå°‚é–€å®¶ã«ã‚‚åˆ†ã‹ã‚‹ç°¡æ½”ã§æ­£ç¢ºãªæ—¥æœ¬èªã®èª¬æ˜ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚å‡ºåŠ›ã¯ã€Œã€ç”¨èªã€‘: èª¬æ˜æ–‡ã€ã®ç®‡æ¡æ›¸ãã€‚';
        const uq = `ä»¥ä¸‹ã®æ–‡å­—èµ·ã“ã—ã‹ã‚‰å°‚é–€ç”¨èªã‚’æŠ½å‡ºã—ã€èª¬æ˜ã—ã¦ãã ã•ã„:\n\n---\n${t}`;
        console.log('Starting term extraction...');
        const text = await callTextGen(sys, uq);
        $out.innerHTML = `<h3>å°‚é–€ç”¨èªåˆ†æçµæœ</h3><pre>${text}</pre>`;
        setStatus('å°‚é–€ç”¨èªåˆ†æãŒå®Œäº†ã—ã¾ã—ãŸã€‚', 'success');
      } catch (e) {
        console.error('Term extraction error:', e);
        const errorMsg = e?.message || String(e);
        $out.innerHTML = `<pre style="color:#c62828">å°‚é–€ç”¨èªåˆ†æã‚¨ãƒ©ãƒ¼: ${errorMsg}\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</pre>`;
        setStatus('å°‚é–€ç”¨èªåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
      } finally {
        updateButtons(false);
      }
    }

    // ===== å±¥æ­´è¡¨ç¤º =====
    function showHistory() {
      const sessions = JSON.parse(localStorage.getItem('transcriptSessions') || '[]');

      if (sessions.length === 0) {
        $historyList.innerHTML = '<p style="color: #666;">ä¿å­˜ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      } else {
        let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
        sessions.forEach((session, index) => {
          const startDate = new Date(session.startTime);
          const endDate = session.endTime ? new Date(session.endTime) : null;
          const duration = endDate ? Math.round((endDate - startDate) / 1000) : null;

          html += `
            <div style="border: 1px solid #ddd; padding: 12px; border-radius: 8px; background: #fafafa;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <div>
                  <strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³ ${index + 1}</strong>
                  <div style="font-size: 13px; color: #666;">
                    ${startDate.toLocaleString('ja-JP')}
                    ${duration ? `(${duration}ç§’)` : ''}
                  </div>
                </div>
                <div>
                  <button class="btn" style="font-size: 12px; padding: 4px 8px;" onclick="loadSession('${session.id}')">èª­ã¿è¾¼ã¿</button>
                  <button class="btn" style="font-size: 12px; padding: 4px 8px;" onclick="deleteSession('${session.id}')">å‰Šé™¤</button>
                </div>
              </div>
              <div style="font-size: 13px; color: #666; margin-bottom: 4px;">
                æ–‡å­—æ•°: ${session.length || session.transcript.length}æ–‡å­—
              </div>
              <div style="max-height: 100px; overflow-y: auto; background: white; padding: 8px; border-radius: 4px; font-size: 13px;">
                ${session.transcript.substring(0, 200)}${session.transcript.length > 200 ? '...' : ''}
              </div>
            </div>
          `;
        });
        html += '</div>';
        $historyList.innerHTML = html;
      }

      $historyModal.style.display = 'block';
    }

    function hideHistory() {
      $historyModal.style.display = 'none';
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹ï¼ˆonclickå±æ€§ã§ä½¿ç”¨ï¼‰
    window.loadSession = function(sessionId) {
      const sessions = JSON.parse(localStorage.getItem('transcriptSessions') || '[]');
      const session = sessions.find(s => s.id === sessionId);
      if (session) {
        $txt.value = session.transcript;
        updateButtons(false);
        hideHistory();
        setStatus('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
      }
    };

    window.deleteSession = function(sessionId) {
      if (!confirm('ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

      const sessions = JSON.parse(localStorage.getItem('transcriptSessions') || '[]');
      const filtered = sessions.filter(s => s.id !== sessionId);
      localStorage.setItem('transcriptSessions', JSON.stringify(filtered));
      showHistory(); // å†è¡¨ç¤º
      setStatus('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    };

    // ===== ã‚¤ãƒ™ãƒ³ãƒˆ =====
    $start.addEventListener('click', startTranscription);
    $stop.addEventListener('click', stopTranscription);
    $sum.addEventListener('click', summarize);
    $terms.addEventListener('click', terms);
    $saveSession.addEventListener('click', saveCurrentSession);
    $viewHistory.addEventListener('click', showHistory);
    $closeHistory.addEventListener('click', hideHistory);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    $historyModal.addEventListener('click', (e) => {
      if (e.target === $historyModal) hideHistory();
    });

    // åˆæœŸ
    updateButtons(false);
  </script>
</body>
</html>
